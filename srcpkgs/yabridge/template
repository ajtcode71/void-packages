# Template file for 'yabridge'
pkgname=yabridge
version=4.0.2
revision=1
archs="i686* x86_64*"
build_style=meson

short_desc="Use Windows 32bit and 64bit VST2 and VST3 plugins in Linux"
maintainer="Anthony Thompson <athompson@posteo.net>"
license="GPL-3.0-or-later"
homepage="https://github.com/robbert-vdh/yabridge"
distfiles="https://github.com/robbert-vdh/yabridge/archive/refs/tags/${version}.tar.gz"
checksum=86fcd65b6f3dd5cf60c2afa476f63959a2cc4ef4d4629810916739d7af645f01
build_options_default="with_32bit"
build_options="with_32bit"

if [ $XBPS_MACHINE = "x86_64-musl" ]; then
	build_options="~with_32bit"
fi

if [ $XBPS_MACHINE = "i686" ] || [ $XBPS_MACHINE = "x86_64-musl" ]; then
		hostmakedepends="ninja pkg-config cmake git cargo"
		makedepends="wine-tools wine-devel libxcb-devel libxcb"
	        depends="wine yabridgectl"

		elif [ $XBPS_LIBC = "glibc" ]; then
			hostmakedepends="ninja cargo pkg-config cmake git $(vopt_if with_32bit "gcc-multilib")"
			makedepends="wine-tools wine-devel libxcb-devel libxcb $(vopt_if with_32bit "wine-devel-32bit") $(vopt_if with_32bit "libxcb-devel-32bit")"
			depends="wine $(vopt_if with_32bit "wine-32bit") yabridgectl"

fi

yabridgectl_package() {
	shortdesc+="Utility to setup and manage yabridge"
	depends="${sourcepkg}"
	pkg_install() {
		cd ${wrksrc}/tools/yabridgectl/target/release
		vbin yabridgectl
	}
}

do_configure() {
		cd ${wrksrc}
		if [  $XBPS_MACHINE = "i686" ]; then
			meson setup build --buildtype=release --cross-file=cross-wine.conf --unity=on --unity-size=1000 -Dbitbridge=true -Dbuild.cpp_args='-m32' -Dbuild.cpp_link_args='-m32'
		else
			meson setup build  --buildtype=release --cross-file=cross-wine.conf --unity=on --unity-size=1000 $(vopt_if with_32bit "-Dbitbridge=true")
		fi
}

do_build() {
	ninja -C build/
	cd ${wrksrc}/tools/yabridgectl
	cargo build --release
}

do_install() {
	cd ${wrksrc}/build
	if  [  $XBPS_MACHINE = "x86_64-musl" ] ||  [ $XBPS_MACHINE = "x86_64" ]; then
		vbin yabridge-host.exe
		vbin yabridge-host.exe.so
		if [ [ $(vopt_if with_32bit  true false) = "true" ] && [ $XBPS_LIBC = "glibc"] ]; then
			vbin yabridge-host-32.exe.so
		 	vbin yabridge-host-32.exe
		fi
	else
		vbin yabridge-host-32.exe.so
		vbin yabridge-host-32.exe
	fi
	vmkdir usr/lib
	vcopy libyabridge-chainloader-vst2.so /usr/lib
	vcopy libyabridge-vst2.so /usr/lib
	vcopy libyabridge-chainloader-vst3.so /usr/lib
	vcopy libyabridge-vst3.so /usr/lib
}
